name: Auto-crop logos (PR-based)

on:
  push:
    paths:
      - 'assets/images/logos/**'
  workflow_dispatch:
    inputs:
      white_thresh:
        description: 'White threshold for background detection (0-255)'
        required: false
        default: '245'
      pad:
        description: 'Padding in pixels to add after cropping'
        required: false
        default: '8'

permissions:
  contents: write

concurrency:
  group: autocrop-agent
  cancel-in-progress: true

jobs:
  autocrop:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow numpy

      - name: Run autocrop agent
        env:
          INPUT_DIR: assets/images/logos
          OUTPUT_DIR: cropped
          CACHE_FILE: '.autocrop_cache.json'
        run: |
          WHITE_THRESH="${{ github.event.inputs.white_thresh || '245' }}"
          PAD="${{ github.event.inputs.pad || '8' }}"
          cd "${{ github.workspace }}"
          python scripts/autocrop.py \
            --input-dir "${INPUT_DIR}" \
            --output-dir "${OUTPUT_DIR}" \
            --white-thresh "${WHITE_THRESH}" \
            --pad "${PAD}" \
            --cache-file "${CACHE_FILE}"

      - name: Ensure no nested .git in output (prevents git errors)
        run: |
          cd "${{ github.workspace }}"
          if [ -d "${{ github.workspace }}/cropped/.git" ]; then
            echo "Removing nested .git in cropped/"
            rm -rf "${{ github.workspace }}/cropped/.git"
          else
            echo "No nested .git in cropped/ found."
          fi

      - name: Debug list cropped contents for quick inspection
        run: |
          cd "${{ github.workspace }}"
          echo "Cropped directory contents:"
          ls -la cropped || echo "cropped directory missing or empty"

      - name: Create pull request with cropped images (if any changes)
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Auto-crop logos: add/updated cropped images [skip ci]"
          branch: "autocrop/changes"
          title: "Auto-crop logos: processed images"
          body: |
            This PR contains auto-cropped versions of images from assets/images/logos/ subdirectories.
            - Cropping is done automatically by scripts/autocrop.py
            - You can adjust the algorithm via workflow inputs or .github/auto-crop.yml
          labels:
            - automated
            - autocrop
          path: cropped